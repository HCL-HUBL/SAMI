BootStrap: docker
From: debian:bullseye

%files
	src/RLE.c /opt/
	
%post
	
	# Debian packages
	apt-get -y update
	apt-get -y install build-essential wget unzip gawk openjdk-11-jre bc
	
	# Versions
	version_gatk="4.2.3.0"
	version_fastqc="0.11.9"
	version_STAR="2.7.9a"
	version_samtools="1.14"
	version_picard="2.26.6"
	version_multiqc="1.11"
	version_Rgb="1.7.4"
	version_Rsubread="2.8.0"
	version_Rsubread_bioc="3.14"
	version_limma="3.49.5"
	version_limma_bioc="3.14"
	version_Rcpp="1.0.6"
	version_locfit="1.5-9.5"
	version_edgeR="3.35.3"
	version_edgeR_bioc="3.14"
	version_zip="2.1.1"
	version_stringi="1.7.4"
	version_openxlsx="4.2.3"
	
	
	
	# Nextflow dependency
	apt-get -y install procps
	
	
	
	# RLE program
	gcc /opt/RLE.c -o /usr/bin/RLE
	
	
	
	# FastQC - perl module dependency
	mkdir -p "/etc/perl"
	wget "https://metacpan.org/release/SHAY/perl-5.30.1/raw/lib/FindBin.pm?download=1" -O "/etc/perl/FindBin.pm"
	
	# FastQC - download
	cd "/tmp"
	wget "https://www.bioinformatics.babraham.ac.uk/projects/fastqc/fastqc_v${version_fastqc}.zip"
	unzip "fastqc_v${version_fastqc}.zip" -d "/opt/"
	
	# FastQC - install
	chmod a+x "/opt/FastQC/fastqc"
	ln -s "/opt/FastQC/fastqc" "/usr/local/bin/fastqc"
	
	
	
	# STAR
	cd "/tmp"
	wget "https://github.com/alexdobin/STAR/archive/${version_STAR}.tar.gz"
	tar xz -C "/opt/" -f "${version_STAR}.tar.gz"
	ln -s "/opt/STAR-${version_STAR}/bin/Linux_x86_64_static/STAR" "/usr/local/bin/STAR"
	
	
	
	# Picard tools
	wget "https://github.com/broadinstitute/picard/releases/download/${version_picard}/picard.jar" -O "/opt/picard.jar"
	
	
	
	# SAMtools / HTSlib - building dependencies
	apt-get -y install bzip2 libz-dev libbz2-dev liblzma-dev libncurses5-dev libcurl4-openssl-dev
	
	# SAMtools / HTSlib - download
	cd "/tmp"
	wget "https://github.com/samtools/samtools/releases/download/${version_samtools}/samtools-${version_samtools}.tar.bz2"
	tar xj -C "/opt/" -f "samtools-${version_samtools}.tar.bz2"
	
	# SAMtools / HTSlib - build from source
	cd "/opt/samtools-${version_samtools}"
	./configure
	make all all-htslib
	make install install-htslib
	
	
	
	# SAMtools / HTSlib - cleanup
	apt-get -y remove bzip2 libz-dev libbz2-dev liblzma-dev libncurses5-dev libcurl4-openssl-dev
	
	
	
	# MultiQC - Python depency
	apt-get -y install python3 python3-setuptools
	
	# MultiQC - download
	cd "/tmp"
	wget "https://github.com/ewels/MultiQC/archive/v${version_multiqc}.zip"
	unzip "v${version_multiqc}.zip" -d "/opt/"
	
	# MultiQC - install from source
	cd "/opt/MultiQC-${version_multiqc}"
	python3 setup.py install
	
	
	
	# R - add CRAN repository <http://cloud.r-project.org/bin/linux/debian/#secure-apt>
	apt-get -y install wget gnupg
	echo "deb http://cloud.r-project.org/bin/linux/debian bullseye-cran40/" >> "/etc/apt/sources.list"
	wget -q -O - 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x95c0faf38db3ccad0c080a7bdc78b2ddeabc47b7' | apt-key add -
	
	# R - install last version from repository
	apt-get -y update
	apt-get -y install r-base
	
	# R - Rgb package
	cd "/tmp"
	wget "https://github.com/maressyl/R.Rgb/releases/download/v${version_Rgb}/Rgb_${version_Rgb}.tar.gz"
	R CMD INSTALL "Rgb_${version_Rgb}.tar.gz"
	
	# R - Rsubread package (version n-1)
	cd "/tmp"
	wget "https://bioconductor.org/packages/${version_Rsubread_bioc}/bioc/src/contrib/Archive/Rsubread/Rsubread_${version_Rsubread}.tar.gz"
	R CMD INSTALL "Rsubread_${version_Rsubread}.tar.gz"
	
	# R - limma dependency (version n-1)
	cd "/tmp"
	wget "https://bioconductor.org/packages/${version_limma_bioc}/bioc/src/contrib/Archive/limma/limma_${version_limma}.tar.gz"
	R CMD INSTALL "limma_${version_limma}.tar.gz"
	
	# R - Rcpp dependency (version n-1)
	cd "/tmp"
	wget "https://cran.rstudio.com/src/contrib/Archive/Rcpp/Rcpp_${version_Rcpp}.tar.gz"
	R CMD INSTALL "Rcpp_${version_Rcpp}.tar.gz"
	
	# R - locfit dependency (version n-1)
	cd "/tmp"
	wget "https://cran.rstudio.com/src/contrib/Archive/locfit/locfit_${version_locfit}.tar.gz"
	R CMD INSTALL "locfit_${version_locfit}.tar.gz"
	
	# R - edgeR package (version n-1)
	cd "/tmp"
	wget "https://bioconductor.org/packages/${version_edgeR_bioc}/bioc/src/contrib/Archive/edgeR/edgeR_${version_edgeR}.tar.gz"
	R CMD INSTALL "edgeR_${version_edgeR}.tar.gz"
	
	# R - zip dependency (version n-1)
	cd "/tmp"
	wget "https://cran.rstudio.com/src/contrib/Archive/zip/zip_${version_zip}.tar.gz"
	R CMD INSTALL "zip_${version_zip}.tar.gz"
	
	# R - stringi dependency (version n-1)
	cd "/tmp"
	wget "https://cran.rstudio.com/src/contrib/Archive/stringi/stringi_${version_stringi}.tar.gz"
	R CMD INSTALL "stringi_${version_stringi}.tar.gz"
	
	# R - openxlsx package (version n-1)
	cd "/tmp"
	wget "https://cran.rstudio.com/src/contrib/Archive/openxlsx/openxlsx_${version_openxlsx}.tar.gz"
	R CMD INSTALL "openxlsx_${version_openxlsx}.tar.gz"
	
	# R - cleanup
	apt-get -y remove gnupg
	
	
	
	# GATK (depends on R, Java 8+ and python 3.7)
	wget "https://github.com/broadinstitute/gatk/releases/download/${version_gatk}/gatk-${version_gatk}.zip"
	unzip "gatk-${version_gatk}.zip" -d "/opt/"
	
	# GATK - use installed python3 for the launch script
	sed 's_^#!/usr/bin/env python$_#!/usr/bin/env python3_' "/opt/gatk-${version_gatk}/gatk" > "/opt/gatk-${version_gatk}/gatk.python3"
	chmod a+x "/opt/gatk-${version_gatk}/gatk.python3"
	ln -s "/opt/gatk-${version_gatk}/gatk.python3" "/usr/local/bin/gatk"
	
	# PIP3
	apt-get -y install python3 python3-pip

	# Cutadapt
	pip3 install cutadapt

	# Final cleanup (unzip is required by R)
	apt-get -y remove build-essential wget
	apt-get -y auto-remove
	
%environment
	
	# MultiQC (Python) request
	export LC_ALL=C.UTF-8
	export LANG=C.UTF-8
	
	# Shortcut
	export Picard="/opt/picard.jar"

%test
	
	### %environment copy (BUG FIX) ###
	
	# MultiQC (Python) request
	export LC_ALL=C.UTF-8
	export LANG=C.UTF-8
	
	# Shortcut
	export Picard="/opt/picard.jar"
	
	
	
	# Custom tools
	echo -e "chr1\t1\t1\nchr1\t2\t1\nchr1\t3\t1" | RLE
	
	# Generic tools
	java --version
	python3 --version
	gunzip --version
	sed --version
	awk --version
	bc --version
	
	# Bioinformatics tools
	gatk --version
	fastqc -v
	STAR --version
	samtools --version
	bgzip --version
	tabix --version
	java -jar "$Picard" 2>&1 | head
	multiqc --version
	cutadapt --version
	
	# R and packages
	Rscript --version
	Rscript -e "library(Rgb); packageVersion('Rgb')"
	Rscript -e "library(Rsubread); packageVersion('Rsubread')"
	Rscript -e "library(limma); packageVersion('limma')"
	Rscript -e "library(Rcpp); packageVersion('Rcpp')"
	Rscript -e "library(locfit); packageVersion('locfit')"
	Rscript -e "library(edgeR); packageVersion('edgeR')"

%help
	This container is not meant to be used directly, but through Nextflow pipeline https://gitlab.inria.fr/NGS/pipelines/rna-seq

%labels
	Author Sylvain Mareschal
	Version 0.6.4

